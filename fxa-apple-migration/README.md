# fxa-apple-migration

This is a set of utilities with a command line interface to do the following:

1. Iterate over all pocket users that have Apple SSO enabled.
2. Utilize Apple's APIs to generate `transfer_sub`s for these users.
3. Persist transfer subs to the database.
4. Aggregate account state that is important to fxa.
5. Write this aggregated data to a CSV that will be sent to fxa.

All of these operations are designed to be independent and composable for flexibility. These operations are all stream based for easy composition.

Static config is provided via environment variables / config files.

Command flags may be used to drive only portions of this script, or to provide batching control. All CSV write operations are appending, and the header row must be manually provided. To get started and see documentation for all flags, run in the `./scripts` directory:

```bash
npm install
npm run build
node dist/fxa-apple-migration/main.js --help
```

## CSV output

CSV content generated by this script is [RFC 4180](https://datatracker.ietf.org/doc/html/rfc4180) compliant.

Since all file changes are appending, csv headers must be added manually:

```
transfer_sub,fxa_user_id,email,alternate_emails
```

`alternate_emails` is `:` (colon) delimited as requested by the fxa team. Otherwise these rows should be simple without complications.

## Log management

Informational logs are output to stdout. Cases where users encounter a terminal error are output to stderr.

Retain all stderr logs while running this script.

Pipes and process substitution work nicely here:

`node dist/fxa-apple-migration/main.js 2> >(tee -a tmp.error.log)` will output all logs to the console and persist error logs by appending to the file `tmp.error.log`.

`node dist/fxa-apple-migration/main.js >> tmp.log 2>> tmp.error.log` will append info logs to `tmp.log` and append all error logs to `tmp.error.log` (and you can follow along with `tail tmp.error.log`)

## Clean me up!

All of this code is intended to be pretty temporary. There is a lot of copy / paste, and this will not be kept up to date with future changes to the primary src directory.
